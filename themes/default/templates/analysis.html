<!DOCTYPE html>
<!--
Copyright 2023 Newcastle University

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.
-->
<html lang="{{options.locale}}">

<head>
    {% with dont_start_exam = True %}
    {% include 'head.html' %}
    {% endwith %}
    <style>
        .table_options {
            display: flex;
            gap: 10px;
        }

        .flex {
            display: flex;
            gap: 10px;
        }

        .scrollbox {
            overflow: auto;
            height: 200px;
        }

        button.selected {
            background-color: #acdeff;
            /*change to '--brand-color when can get that to work*/
            color: hsl(204, 50.2%, 34.9%);
        }
    </style>
</head>

<body>
    <div id=data_display>
        <div data-bind="visible:current_page()=='upload'">
            <h1>Student Result Analysis</h1>
            <label for="student_results">Choose student results files</label>
            <input type="file" id="student_results" name="student_results" accept=".txt" multiple
                data-bind="event: {change: function() {add_files($element.files)}}">
        </div>
        <div data-bind="visible:current_page()=='processing'">
            <h1>Processing files</h1>
            <p>The files you uploaded are being processed. Valid files will be listed in 'Processed Files', files which
                could not be interpreted will be listed in 'Skipped Files'. Additional files can be uploaded.</p>
            <p data-bind="visible:failed_files().length">If a file is skipped, it means that the decoding did not return
                a valid file. If you have changed the passcode, try previous passcodes. Otherwise, the file may have
                been tampered with.</p>
            <div class=flex>
                <div>
                    <h2>Processed Files</h2>
                    <div class=scrollbox data-bind="foreach: decrypted_files">
                        <p data-bind="text: $data.content.student_name + ': '+ $data.filename"></p>
                    </div>
                </div>
                <div>
                    <h2>Skipped Files</h2>
                    <p data-bind="visible:!failed_files().length">No files have been skipped.</p>
                    <div class=scrollbox data-bind="foreach: failed_files, visible:failed_files().length">
                        <p data-bind="text: $data.name"></p>
                    </div>
                </div>
                <div>
                    <label for="student_results">
                        <h2>Upload additional files</h2>
                    </label>
                    <input type="file" id="student_results" name="student_results" accept=".txt" multiple
                        data-bind="event: {change: function() {add_files($element.files)}}">
                    <label for="passcode_override">Override Decryption Passcode</label>
                    <input id="passcode_override" type="checkbox" data-bind="checked: override_passcode">
                    <input id="passcode_override"
                        data-bind=" visible: override_passcode, textInput: overridden_passcode">
                </div>
            </div>
            <h2>Table Format</h2>
            <div class=flex data-bind="foreach: table_format_options">
                <!--For each option, have a big clean button with description, and then a 'show table' button-->
                <div>
                    <button
                        data-bind="click: function() {$root.set_table_display($data.label)}, css: {selected: $root.table_format()==$data.label}">
                        <h3 data-bind="text:$data.name"></h3>
                        <span data-bind="text:$data.description"></span>
                    </button>
                </div>
            </div>
            <button data-bind="click: function() {move_page('table')}">Show Table</button>
        </div>
        <div data-bind="visible:current_page()=='table'">
            <button data-bind="click: function() {move_page('processing')}">Upload more files</button>
            <div class=flex>
                <label for="change_display">Change Display</label>
                <select name="change_display" data-bind="options:table_format_labels, value:table_format"></select>
                <button data-bind="click: download_full_table">Download Full Table</button>
                <button data-bind="click: download_table">Download Current Table</button>
            </div>
            <div class=table_display data-bind="visible: table_format()=='total'">
                <table>
                    <tr>
                        <th>Student Name</th>
                        <th>Student Score</th>
                        <th>Maximum Score</th>
                        <th>Percentage</th> <!--TODO: Map to other languages-->
                    </tr>
                    <tbody data-bind="foreach: decrypted_files">
                        <tr>
                            <td data-bind="text: $data.content.student_name"></td>
                            <td data-bind="text: $data.content.score"></td>
                            <td data-bind="text: $data.content.max_score"></td>
                            <td data-bind="text: (100*$data.content.score/$data.content.max_score)+'%'"></td>
                            <!--TODO: Need to fix percentage display-->
                        </tr>

                    </tbody>
                </table>
            </div>
            <div class=table_display data-bind="visible: table_format()=='question'">
                <table>
                    <tr data-bind="foreach: table_header_webpage">
                        <th data-bind="text: $data"></th>
                    </tr>
                    <tbody data-bind="foreach: table_body">
                        <tr data-bind="foreach: $data">
                            <td data-bind="text: $data"></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class=table_display data-bind="visible: table_format()=='all'">
                <table>
                    <tr data-bind="foreach: table_header_webpage">
                        <th data-bind="text: $data"></th>
                    </tr>
                    <tbody data-bind="foreach: table_body">
                        <tr data-bind="foreach: $data">
                            <td data-bind="text: $data"></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>
    <script>
        Numbas.queueScript('go',['analysis-display'],function() {
            Numbas.analysis.init();
        });
        $(function() {
            Numbas.checkAllScriptsLoaded();
        });
    </script>
</body>

</html>
